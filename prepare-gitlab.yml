---
- hosts: all
  become: true

  vars:
    gitlab_domain: "gitlab.jonashackt.io"
    gitlab_url: "https://{{ gitlab_domain }}"
    gitlab_registry_url: "{{ gitlab_url }}:4567"
    https_internal_server: true

  tasks:
  - name: Checking Ansible connectivity to Linux nodes
    ping:

  - name: Prepare Docker on Linux node
    include_tasks: prepare-docker-linux.yml
    tags: install_docker

  - name: Prepare LetÂ´s Encrypt certificates for Gitlab
    include_tasks: letsencrypt.yml
    when: https_internal_server
    tags: letsencrypt

  - name: Install Gitlab on Linux node
    include_tasks: install-gitlab.yml
    tags: install_gitlab

  - name: Configure Gitlab Container Registry
    include_tasks: configure-gitlab-registry.yml
    tags: configure_registry

  - name: Install & Configure Gitlab Runner for Docker
    include_tasks: gitlab-runner.yml
    tags: gitlab_runner

  - name: Congratulations!
    debug:
      msg:
        - "Your Gitlab instance is ready at {{ gitlab_url }} and the Gitlab Container Registry is waiting for your docker pushes (at {{ gitlab_registry_url}})."
        - "Just open your Browser and login!"
